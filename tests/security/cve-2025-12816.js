'use strict';

const assert = require('assert');
const forge = require('../../lib/forge');
const md = require('../../lib/md');
const pkcs12 = require('../../lib/pkcs12');
const asn1 = require('../../lib/asn1');
const pki = require('../../lib/pki');

/**
 * Build a minimal certificate-only PKCS#12 (PFX) with a MAC.
 */
function buildCertOnlyPfxWithMac(password) {
  const keys = pki.rsa.generateKeyPair({ bits: 1024, e: 0x10001 });
  const cert = pki.createCertificate();
  cert.publicKey = keys.publicKey;
  cert.serialNumber = '01';
  cert.validity.notBefore = new Date();
  cert.validity.notAfter = new Date();
  cert.validity.notAfter.setFullYear(cert.validity.notBefore.getFullYear() + 1);
  cert.setSubject([{ name: 'commonName', value: 'p12-demo' }]);
  cert.setIssuer([{ name: 'commonName', value: 'p12-demo' }]);
  cert.sign(keys.privateKey, md.sha256.create());

  return pkcs12.toPkcs12Asn1(
    null,
    cert,
    password,
    { useMac: true, count: 2048, saltSize: 8 }
  );
}

/**
 * Replace macData node with arbitrary junk.
 */
function corruptMacData(pfxAsn1) {
  const clone = asn1.fromDer(asn1.toDer(pfxAsn1).getBytes());
  // Replace 3rd element (macData) with garbage node
  clone.value[2] = asn1.create(
    asn1.Class.UNIVERSAL,
    asn1.Type.OCTETSTRING,
    false,
    'JUNK'
  );
  return clone;
}

describe('PKCS#12 MAC corruption security test', function () {
  const correctPw = 'correct-horse-battery-staple';
  const wrongPw = 'wrong-password';
  let legit;

  before(function () {
    legit = buildCertOnlyPfxWithMac(correctPw);
  });

  it('accepts valid PFX with correct password', function () {
    assert.doesNotThrow(() => {
      const obj = pkcs12.pkcs12FromAsn1(legit, true, correctPw);
      assert(obj, 'pkcs12FromAsn1 should return an object');
    });
  });

  it('rejects valid PFX with wrong password (MAC mismatch)', function () {
    assert.throws(() => {
      pkcs12.pkcs12FromAsn1(legit, true, wrongPw);
    }, /MAC|password|verify/i);
  });

  it('rejects tampered PFX with corrupted macData', function () {
    const tampered = corruptMacData(legit);
    assert.throws(() => {
      pkcs12.pkcs12FromAsn1(tampered, true, wrongPw);
    }, /mac|digest|invalid|malformed/i);
  });
});

